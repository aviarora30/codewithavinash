<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    {% assign meta_title = page.title | default: site.title %}
    {% if page.collection == "notes" and page.title %}
      {% assign meta_title = page.title | append: " | " | append: site.title %}
    {% endif %}
    {% assign
    meta_description = page.description | default: page.summary %} {% assign
    meta_description = meta_description | default: site.description %} {% assign
    meta_url = page.url | absolute_url %} {% assign meta_type = page.og_type |
    default: "website" %} {% if page.collection == "notes" %} {% assign
    meta_type = "article" %} {% assign meta_image = page.og_image | default:
    page.image %} {% else %} {% assign meta_image = page.og_image | default:
    site.image %} {% endif %}

    <title>{{ meta_title }}</title>
    {% if meta_description %}
    <meta name="description" content="{{ meta_description }}" />
    {% endif %}
    {% if page.canonical %}
      <link rel="canonical" href="{{ page.canonical }}" />
    {% else %}
      <link rel="canonical" href="{{ meta_url }}" />
    {% endif %}

    {% if meta_image %}
      {% assign og_image_ext = meta_image | split: "." | last | downcase %}
      {% assign og_image_type = "" %}
      {% if og_image_ext == "png" %}
        {% assign og_image_type = "image/png" %}
      {% elsif og_image_ext == "jpg" or og_image_ext == "jpeg" %}
        {% assign og_image_type = "image/jpeg" %}
      {% elsif og_image_ext == "webp" %}
        {% assign og_image_type = "image/webp" %}
      {% elsif og_image_ext == "gif" %}
        {% assign og_image_type = "image/gif" %}
      {% endif %}
    {% endif %}

    <meta property="og:title" content="{{ meta_title }}" />
    {% if meta_description %}
    <meta property="og:description" content="{{ meta_description }}" />
    {% endif %}
    <meta property="og:type" content="{{ meta_type }}" />
    <meta property="og:url" content="{{ meta_url }}" />
    {% if meta_image %}
      <meta property="og:image" content="{{ meta_image | absolute_url }}" />
      {% if og_image_type %}
        <meta property="og:image:type" content="{{ og_image_type }}" />
      {% endif %}
    {% endif %}

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="{{ meta_title }}" />
    {% if meta_description %}
    <meta name="twitter:description" content="{{ meta_description }}" />
    {% endif %} {% if meta_image %}
    <meta name="twitter:image" content="{{ meta_image | absolute_url }}" />
    {% endif %}

    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-8N7ZS3VK57"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-8N7ZS3VK57");
    </script>

    <link rel="stylesheet" href="/styles.css" />
    {% if page.notes_styles or page.collection == "notes" %}
    <link rel="stylesheet" href="/notes/notes.css" />
    {% endif %}
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  </head>
  <body>
    {% include header.html %} {{ content }} {% include footer.html %}
    <script>
      (function () {
        var header = document.querySelector("header");
        function updateStickyHeader() {
          var halfHeader = header.offsetHeight / 2;
          if (window.scrollY > halfHeader) {
            header.classList.add("is-stuck");
          } else {
            header.classList.remove("is-stuck");
          }
        }
        window.addEventListener("scroll", updateStickyHeader, { passive: true });
        updateStickyHeader();
      })();
    </script>
    <script>
      (function () {
        function sendEvent(eventName, params) {
          if (typeof gtag === "function") {
            gtag("event", eventName, params || {});
          }
        }

        function isExternalLink(href) {
          if (!href) return false;
          if (href.startsWith("mailto:")) return true;
          if (href.startsWith("http://") || href.startsWith("https://")) {
            try {
              return new URL(href).host !== window.location.host;
            } catch (error) {
              return false;
            }
          }
          return false;
        }

        document.addEventListener("click", function (event) {
          var link = event.target.closest("a");
          if (!link) return;

          var href = link.getAttribute("href");
          if (isExternalLink(href)) {
            sendEvent("outbound_click", {
              link_url: href,
              link_text: (link.textContent || "").trim(),
              page_location: window.location.href,
            });
          }

          if (link.closest(".note-list")) {
            sendEvent("note_click", {
              note_title: (link.textContent || "").trim(),
              note_url: href,
              page_location: window.location.href,
            });
          }
        });

        var sentScrollMarks = {};
        var scrollMarks = [25, 50, 75, 100];
        function trackScrollDepth() {
          var doc = document.documentElement;
          var scrollTop = window.pageYOffset || doc.scrollTop || 0;
          var height = doc.scrollHeight - doc.clientHeight;
          if (height <= 0) return;
          var percent = Math.round((scrollTop / height) * 100);
          scrollMarks.forEach(function (mark) {
            if (percent >= mark && !sentScrollMarks[mark]) {
              sentScrollMarks[mark] = true;
              sendEvent("scroll_depth", {
                percent: mark,
                page_location: window.location.href,
              });
            }
          });
        }

        var scrollTimeout;
        window.addEventListener("scroll", function () {
          if (scrollTimeout) return;
          scrollTimeout = window.setTimeout(function () {
            scrollTimeout = null;
            trackScrollDepth();
          }, 200);
        });

        document.addEventListener("visibilitychange", function () {
          if (document.visibilityState === "hidden") {
            sendEvent("page_exit", {
              page_location: window.location.href,
            });
          }
        });
      })();
    </script>
  </body>
</html>
